<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Factura - La Neverita</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
    body { font-family: 'Poppins', sans-serif; }

    @media print {
      .no-print { display: none !important; }
      body { background: white !important; }
      .invoice-box { box-shadow: none !important; border: none !important; }
      .watermark { opacity: 0.06 !important; }
    }

    .watermark {
      position: absolute; font-size: 140px; transform: rotate(-45deg);
      opacity: 0.06; pointer-events: none; font-weight: 800; color: #9ca3af;
    }
  </style>
</head>
<body class="bg-white text-gray-700 min-h-screen flex items-center justify-center p-4">

  <div class="invoice-box bg-white border border-gray-200 max-w-3xl w-full print-section relative overflow-hidden">
    <!-- Marca de agua -->
    <div class="watermark absolute -top-10 -left-10">LA NEVERITA</div>
    
    <!-- Header -->
    <div class="flex items-center px-6 py-6 border-b border-gray-200">
      <div class="bg-gray-100 p-3 rounded-full mr-4">
        <span class="text-gray-800 text-2xl">üç¶</span>
      </div>
      <div>
        <h1 class="text-lg font-bold text-gray-800">LA NEVERITA</h1>
        <p class="text-xs text-gray-500">Helados Artesanales</p>
      </div>

      <!-- Bot√≥n imprimir -->
      <div class="no-print ml-auto">
        <button onclick="window.print()"
          class="bg-gray-800 text-white px-4 py-2 rounded-md font-medium shadow hover:bg-gray-700 transition flex items-center gap-2">
          üñ®Ô∏è Imprimir
        </button>
      </div>
    </div>
    
    <div class="p-8 relative">
      <!-- Total destacado -->
      <div class="bg-gray-50 border border-gray-200 rounded-md p-4 mb-6 text-center">
        <p class="text-sm text-gray-500">Total a pagar</p>
        <p id="total" class="text-2xl font-bold text-gray-800"></p>
      </div>

      <!-- Invoice header -->
      <div class="mb-6">
        <h2 class="text-base font-semibold text-gray-800">Factura</h2>
        <p class="text-sm text-gray-600">N¬∫ <span id="invoiceNumber">LN-2025-00001</span></p>
        <p class="text-sm text-gray-600" id="date"></p>
        <p class="mt-2"><strong>Cliente:</strong> <span id="customerName"></span></p>
        <p><strong>M√©todo de Pago:</strong> <span id="paymentMethod"></span></p>
      </div>
      
      <!-- Tabla de productos -->
      <div class="mb-2 overflow-hidden border border-gray-200 rounded-md">
        <table class="w-full border-collapse text-sm">
          <thead class="bg-gray-100 text-gray-700">
            <tr>
              <th class="px-4 py-2 text-left">Producto</th>
              <th class="px-4 py-2 text-center">Cant.</th>
              <th class="px-4 py-2 text-right">Precio</th>
              <th class="px-4 py-2 text-right">Total</th>
            </tr>
          </thead>
          <tbody id="items" class="text-gray-700"></tbody>
        </table>
      </div>

      <!-- Total al final de la tabla -->
      <div class="flex justify-end mb-6">
        <div class="w-full md:w-1/3 text-right">
          <p class="text-base font-semibold text-gray-800 border-t pt-3">
            Total: <span id="tableTotal"></span>
          </p>
        </div>

        
      </div>
      
      <!-- Footer -->
      <div class="text-center text-xs text-gray-500 border-t pt-4">
        <p>Gracias por su compra.</p>
        <p class="mt-2">La Neverita S.L. ‚Ä¢ CIF: B12345678 ‚Ä¢ Tel: +34 91 234 56 78 ‚Ä¢ www.laneverita.com</p>
      </div>
    </div>
  </div>

  <script>
    const EUR = new Intl.NumberFormat("es-ES", { style: "currency", currency: "EUR" });
    const USD = new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" });
    const fmt = (n, currency="USD") => ({ EUR, USD }[currency] || USD).format(n);

    const invoice = JSON.parse(localStorage.getItem("lastInvoice"));
    if (invoice) {
      if (!invoice.invoiceNumber) {
        invoice.invoiceNumber = 'LN-' + new Date().getFullYear() + '-' + Math.floor(10000 + Math.random() * 90000);
      }
      document.getElementById("date").textContent = invoice.date;
      document.getElementById("customerName").textContent = invoice.customerName || "Cliente";
      document.getElementById("paymentMethod").textContent = invoice.paymentMethod || "Efectivo";
      document.getElementById("invoiceNumber").textContent = invoice.invoiceNumber;

      const total = invoice.total || (invoice.cartEntries ?
        invoice.cartEntries.reduce((sum, item) => sum + (item.lineTotal || 0), 0) : 0);

      document.getElementById("total").textContent = fmt(total, invoice.currency);
      document.getElementById("tableTotal").textContent = fmt(total, invoice.currency);

      const tbody = document.getElementById("items");
      if (invoice.cartEntries && invoice.cartEntries.length > 0) {
        invoice.cartEntries.forEach(item => {
          const row = document.createElement("tr");
          row.className = "border-b border-gray-200";
          row.innerHTML = `
            <td class="px-4 py-2">${item.name}</td>
            <td class="px-4 py-2 text-center">${item.qty}</td>
            <td class="px-4 py-2 text-right">${fmt(item.unitPrice, invoice.currency)}</td>
            <td class="px-4 py-2 text-right font-medium">${fmt(item.lineTotal, invoice.currency)}</td>
          `;
          tbody.appendChild(row);
        });
      } else {
        tbody.innerHTML = `<tr><td colspan="4" class="px-4 py-4 text-center text-gray-400">No hay productos</td></tr>`;
      }
    }
  </script>
</body>
</html>
